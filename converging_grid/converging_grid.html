<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title><code>CP2K</code> Tutorial: How To Converge The Multi-Grid Used in <code>QUICKSTEP</code></title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="<code>CP2K</code> Tutorial: How To Converge The Multi-Grid Used in <code>QUICKSTEP</code>"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="Wednesday, 2014/01/22"/>
<meta name="author" content="Lianheng Tong"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<style type="text/css">
/*<![CDATA[*/
  .textsc {font-variant: small-caps;}
/*]]>*/
</style>

<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

<!-- The org-mode default configuration, with some of my modifications -->
<script type="text/x-mathjax-config">
/*<![CDATA[*/
  MathJax.Hub.Config({
    // Only one of the two following lines, depending on user settings
    // First allows browser-native MathML display, second forces HTML/CSS
        config: ["MMLorHTML.js"], jax: ["input/TeX"],
    //  jax: ["input/TeX", "output/HTML-CSS"],
    extensions: ["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js",
                 "TeX/noUndefined.js"],
    tex2jax: {
      inlineMath: [ ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"],
                     ["\\begin{displaymath}","\\end{displaymath}"] ],
      skipTags: ["script","noscript","style","textarea","pre","code"],
      ignoreClass: "tex2jax_ignore",
      processEscapes: false,
      processEnvironments: true,
      preview: "TeX"
    },
    showProcessingMessages: true,
    displayAlign: "center",
    displayIndent: "2em",

    "HTML-CSS": {
      scale: 100,
      availableFonts: ["STIX","TeX"],
      preferredFont: "TeX",
      webFont: "TeX",
      imageFont: "TeX",
      showMathMenu: true,
    },
    MMLorHTML: {
      prefer: {
        MSIE:    "MML",
        Firefox: "MML",
        Opera:   "HTML",
        Safari:  "HTML",
        other:   "HTML"
      }
    }
  });
/*]]>*/
</script>

<!-- switching on equation numbers support -->
<script type="text/x-mathjax-config">
/*<![CDATA[*/
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
/*]]>*/
</script>

<!-- Loading mathjax javascript using preamble and my math definitions -->
<script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title"><code>CP2K</code> Tutorial: How To Converge The Multi-Grid Used in <code>QUICKSTEP</code></h1>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 Introduction</a>
<ul>
<li><a href="#sec-1-1">1.1 <code>QUICKSTEP</code> Multi-Grid</a></li>
</ul>
</li>
<li><a href="#sec-2">2 Example: Bulk Si with 8 atoms in a cubic cell</a>
<ul>
<li><a href="#sec-2-1">2.1 Template Input File</a></li>
<li><a href="#sec-2-2">2.2 Converging <code>CUTOFF</code></a>
<ul>
<li><a href="#sec-2-2-1">2.2.1 Generating Inputs</a></li>
<li><a href="#sec-2-2-2">2.2.2 Running Calculations</a></li>
<li><a href="#sec-2-2-3">2.2.3 Analysing Results</a></li>
</ul>
</li>
<li><a href="#sec-2-3">2.3 Converging <code>REL_CUTOFF</code></a>
<ul>
<li><a href="#sec-2-3-1">2.3.1 Generating Inputs</a></li>
<li><a href="#sec-2-3-2">2.3.2 Running Calculations</a></li>
<li><a href="#sec-2-3-3">2.3.3 Analysing Results</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">


<p>  
  <code>QUICKSTEP</code>, as with nearly all ab initio Density Functional Theory
  simulation packages, requires the use of a real-space (RS)
  integration grid to represent certain functions, such as the
  electron density and the product Gaussian functions. <code>QUICKSTEP</code>
  uses a multi-grid system for mapping the product Gaussians onto the
  RS grid(s), so that wide and smooth Gaussian functions are mapped
  onto a coarser grid than narrow and sharp Gaussians. The electron
  density is always mapped onto the finest grid.
</p>
<p>
  Choosing a fine enough integration grid for a calculation is crucial
  in obtaining meaningful and accurate results. In this tutorial, we
  will show the reader how to systematically find the correct settings
  for obtaining a sufficiently fine integration grid for his/her
  calculation.
</p>
<p>
  This tutorial assumes the reader already has some knowledge of how
  to perform a simple energy calculation using <code>QUICKSTEP</code> (this can
  be found in tutorial: Simple energy and force calculation using
  <code>QUICKSTEP</code>).
</p>
<p>
  A completed example from an earlier calculation can be obtained from
  the file <code>converging_grid.tgz</code> that comes with this tutorial. The
  calculations were carried out using CP2K SVN trunk revision 13180.
</p>

</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> <code>QUICKSTEP</code> Multi-Grid</h3>
<div class="outline-text-3" id="text-1-1">


<p>
   Before we go through the input file, it is worth while to explain
   how the multi-grid is constructed in <code>QUICKSTEP</code>, and how the
   Gaussians are mapped onto the different grid levels. Hopefully this
   will offer the reader with a clear picture of how the key control
   parameters affect the grids, and thus the overall accuracy of a
   calculation.
</p>
<p>
   All multi-grid related settings for a calculation is controlled via
   keywords in <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html"><code>MULTIGRID</code></a> subsection of <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT.html"><code>DFT</code></a> subsection in
   <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL.html"><code>FORCE_EVAL</code></a>. The number of levels for the multi-grid is defined by
   <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_NGRIDS"><code>NGRIDS</code></a>, and by default this is set to 4. The keyword <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>
   defines the planewave cutoff (default unit is in Ry) for the
   <i>finest</i> level of the multi-grid.  The higher the planewave cutoff,
   the finer the grid. The corresponding planewave cutoffs for the
   subsequent grid levels (from finer to coarser) are defined by the
   formula:
   \begin{equation*}
     E^i_{\mathrm{cut}} = \frac{E_{\mathrm{cut}}^1}
                               {\alpha^(i-1)}
   \end{equation*}
   where \(\alpha\) has a default value of 3.0, and since <code>CP2K</code>
   versions 3.0, can be configured by the keyword
   <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#list_PROGRESSION_FACTOR"><code>PROGRESSION_FACTOR</code></a>. Therefore, the higher the value of <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>
   the finer grid for all multi-grid levels.
</p>
<p>
   Having constructed the multi-grid, <code>QUICKSTEP</code> then needs to map
   the Gaussians onto the grids. The keyword <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> controls
   which product Gaussians are mapped onto which level of the
   multi-grid.  <code>CP2K</code> tries to map each Gaussian onto a grid such
   that the number of grid points covered by the Gaussian&mdash;no matter
   how wide or narrow&mdash;are roughly the same. <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> defines the
   planewave cutoff of a reference grid covered by a Gaussian with
   unit standard deviation (\(e^{\lvert\vec{r}\rvert^2}\)). A Gaussian
   is mapped onto the coarsest level of the multi-grid, on which the
   function will cover number of grid points greater than or equal to
   the number of grid points \(e^{\lvert\vec{r}\rvert^2}\) will cover on
   a reference grid defined by <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a>.
</p>
<p>
   Therefore, the two most important keywords effecting the
   integration grid and the accuracy of a calculation are <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> and
   <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTFF</code></a>. If <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> is too low, then all grids will be coarse
   and the calculation may become inaccurate; and if <code>REL_CUTOFF</code> is
   too low, then even if you have a high <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>, all Gaussians will
   be mapped onto the coarsest level of the multi-grid, and thus the
   effective integration grid for the calculation may still be too
   coarse.
</p>
</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Example: Bulk Si with 8 atoms in a cubic cell</h2>
<div class="outline-text-2" id="text-2">


<p>
  We demonstrate the process using an example based on Bulk Si with 8
  atoms in a face centred cubic unit cell.
</p>

</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Template Input File</h3>
<div class="outline-text-3" id="text-2-1">


<p>  
   To systematically find the best <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> and <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> values
   which are sufficient for a given accuracy (say, \(10^-6\) Ry in total
   energy), we need to perform a series of single point energy
   calculations. It is much easier to use a set of scripts that can
   automate this process.
</p>
<p>
   To do this, we first write a template input file: <code>template.inp</code>,
   as shown below:
</p>



<pre class="src src-cp2k"><span style="color: #268bd2;">&amp;GLOBAL</span>
  <span style="color: #859900; font-weight: bold;">PROJECT</span> Si_bulk8
  <span style="color: #859900; font-weight: bold;">RUN_TYPE</span> ENERGY
  <span style="color: #859900; font-weight: bold;">PRINT_LEVEL</span> MEDIUM
<span style="color: #268bd2;">&amp;END GLOBAL</span>
<span style="color: #268bd2;">&amp;FORCE_EVAL</span>
  <span style="color: #859900; font-weight: bold;">METHOD</span> Quickstep
  <span style="color: #268bd2;">&amp;DFT</span>
    <span style="color: #859900; font-weight: bold;">BASIS_SET_FILE_NAME</span>  BASIS_SET
    <span style="color: #859900; font-weight: bold;">POTENTIAL_FILE_NAME</span>  GTH_POTENTIALS
    <span style="color: #268bd2;">&amp;MGRID</span>
      <span style="color: #859900; font-weight: bold;">CUTOFF</span> LT_cutoff
      <span style="color: #859900; font-weight: bold;">REL_CUTOFF</span> LT_rel_cutoff
    <span style="color: #268bd2;">&amp;END MGRID</span>
    <span style="color: #268bd2;">&amp;QS</span>
      <span style="color: #859900; font-weight: bold;">EPS_DEFAULT</span> 1.0E-10
    <span style="color: #268bd2;">&amp;END QS</span>
    <span style="color: #268bd2;">&amp;SCF</span>
      <span style="color: #859900; font-weight: bold;">SCF_GUESS</span> ATOMIC
      <span style="color: #859900; font-weight: bold;">EPS_SCF</span> 1.0E-6
      <span style="color: #859900; font-weight: bold;">MAX_SCF</span> 1
      <span style="color: #859900; font-weight: bold;">ADDED_MOS</span> 10
      <span style="color: #859900; font-weight: bold;">CHOLESKY</span> INVERSE
      <span style="color: #268bd2;">&amp;SMEAR</span> ON
        <span style="color: #859900; font-weight: bold;">METHOD</span> FERMI_DIRAC
        <span style="color: #859900; font-weight: bold;">ELECTRONIC_TEMPERATURE</span> [K] 300
      <span style="color: #268bd2;">&amp;END SMEAR</span>
      <span style="color: #268bd2;">&amp;DIAGONALIZATION</span>
        <span style="color: #859900; font-weight: bold;">ALGORITHM</span> STANDARD
      <span style="color: #268bd2;">&amp;END DIAGONALIZATION</span>
      <span style="color: #268bd2;">&amp;MIXING</span>
        <span style="color: #859900; font-weight: bold;">METHOD</span> BROYDEN_MIXING
        <span style="color: #859900; font-weight: bold;">ALPHA</span> 0.4
        <span style="color: #859900; font-weight: bold;">BETA</span> 0.5
        <span style="color: #859900; font-weight: bold;">NBROYDEN</span> 8
      <span style="color: #268bd2;">&amp;END MIXING</span>
    <span style="color: #268bd2;">&amp;END SCF</span>
    <span style="color: #268bd2;">&amp;XC</span>
      <span style="color: #268bd2;">&amp;XC_FUNCTIONAL</span> PADE
      <span style="color: #268bd2;">&amp;END XC_FUNCTIONAL</span>
    <span style="color: #268bd2;">&amp;END XC</span>
  <span style="color: #268bd2;">&amp;END DFT</span>
  <span style="color: #268bd2;">&amp;SUBSYS</span>
    <span style="color: #268bd2;">&amp;KIND</span> Si
      <span style="color: #859900; font-weight: bold;">ELEMENT</span>   Si
      <span style="color: #859900; font-weight: bold;">BASIS_SET</span> SZV-GTH-PADE
      <span style="color: #859900; font-weight: bold;">POTENTIAL</span> GTH-PADE-q4
    <span style="color: #268bd2;">&amp;END KIND</span>
    <span style="color: #268bd2;">&amp;CELL</span>
      <span style="color: #859900; font-weight: bold;">SYMMETRY</span> CUBIC
      <span style="color: #859900; font-weight: bold;">A</span>     5.430697500    0.000000000    0.000000000
      <span style="color: #859900; font-weight: bold;">B</span>     0.000000000    5.430697500    0.000000000
      <span style="color: #859900; font-weight: bold;">C</span>     0.000000000    0.000000000    5.430697500
    <span style="color: #268bd2;">&amp;END CELL</span>
    <span style="color: #268bd2;">&amp;COORD</span>
      <span style="color: #859900; font-weight: bold;">Si</span>    0.000000000    0.000000000    0.000000000
      <span style="color: #859900; font-weight: bold;">Si</span>    0.000000000    2.715348700    2.715348700
      <span style="color: #859900; font-weight: bold;">Si</span>    2.715348700    2.715348700    0.000000000
      <span style="color: #859900; font-weight: bold;">Si</span>    2.715348700    0.000000000    2.715348700
      <span style="color: #859900; font-weight: bold;">Si</span>    4.073023100    1.357674400    4.073023100
      <span style="color: #859900; font-weight: bold;">Si</span>    1.357674400    1.357674400    1.357674400
      <span style="color: #859900; font-weight: bold;">Si</span>    1.357674400    4.073023100    4.073023100
      <span style="color: #859900; font-weight: bold;">Si</span>    4.073023100    4.073023100    1.357674400
    <span style="color: #268bd2;">&amp;END COORD</span>
  <span style="color: #268bd2;">&amp;END SUBSYS</span>
  <span style="color: #268bd2;">&amp;PRINT</span>
    <span style="color: #268bd2;">&amp;TOTAL_NUMBERS</span>  ON
    <span style="color: #268bd2;">&amp;END TOTAL_NUMBERS</span>
  <span style="color: #268bd2;">&amp;END PRINT</span>
<span style="color: #268bd2;">&amp;END FORCE_EVAL</span>
</pre>


<p>
   We go through this input file quickly. Readers who have gone
   through the tutorial on how to perform a simple static energy and
   force calculation using <code>QUICKSTEP</code> should have no trouble in
   understanding most parts the above input.
</p>
<p>
   Some noticeable settings are:
</p>


<pre class="src src-cp2k"><span style="color: #268bd2;">&amp;GLOBAL</span>
  <span style="color: #859900; font-weight: bold;">PROJECT</span> Si_bulk8
  <span style="color: #859900; font-weight: bold;">RUN_TYPE</span> ENERGY
  <span style="color: #859900; font-weight: bold;">PRINT_LEVEL</span> MEDIUM
<span style="color: #268bd2;">&amp;END GLOBAL</span>
</pre>

<p>
   The keyword <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/GLOBAL.html#desc_RUN_TYPE"><code>RUN_TYPE</code></a> is set to <code>ENERGY</code>, this tells <code>CP2K</code> to only
   calculate the energies of the system, forces will not be
   calculated. Since we are only interested in the convergence of the
   integration grid, just looking at the total energy usually suffices;
   and since we will be performing a series of computations, the
   cheaper each run is the better. We set <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/GLOBAL.html#desc_PRINT_LEVEL"><code>PRINT_LEVEL</code></a> to <code>MEDIUM</code>, so
   that the information about how many Gaussian functions are mapped
   onto which grid are printed. We need this information to analyse the
   suitability of the chosen <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> value.
</p>
<p>
   The most important part in the template input is:
</p>


<pre class="src src-cp2k"><span style="color: #268bd2;">&amp;MGRID</span>
  <span style="color: #859900; font-weight: bold;">CUTOFF</span> LT_cutoff
  <span style="color: #859900; font-weight: bold;">REL_CUTOFF</span> LT_rel_cutoff
<span style="color: #268bd2;">&amp;END MGRID</span>  
</pre>

<p>
   The symbols <code>LT_cutoff</code> and <code>LT_rel_cutoff</code> are <i>markers</i>, which
   the automated scripts will search for and replace with the relevant
   values. The default units for both <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> and <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> are
   Ry.
</p>
<p>
   In <code>SCF</code> subsection, we have set
</p>


<pre class="src src-cp2k"><span style="color: #859900; font-weight: bold;">MAX_SCF</span> 1
</pre>

<p>
   So that no self-consistent loops will be performed. This is okay for
   checking the integration grid, because irrespective of
   self-consistency, grid settings with fine enough meshes should give
   consistent energies.
</p>
</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Converging <code>CUTOFF</code></h3>
<div class="outline-text-3" id="text-2-2">


<p>   
   We start by setting <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> to a relatively high number, and
   systematically vary <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>. Setting <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> to 60 Ry is
   usually sufficient for most calculations, and in any case this will
   be checked later when we vary <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a>.
</p>

</div>

<div id="outline-container-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> Generating Inputs</h4>
<div class="outline-text-4" id="text-2-2-1">


<p>
    We want to perform a series of calculations, with <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> ranging
    from 50 Ry to 500 Ry in steps of 50 Ry. From experience, the
    desired <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> for an accuracy of \(10^{-6}\) Ry for the total
    energy should be well within this range. To do this, we first need
    to make sure the basis and pseudopotential parameter files
    <code>BASIS_SET</code> and <code>GTH_POTENTIALS</code> are in the working directory
    together with <code>template.inp</code>, then one can write a bash script,
    such as the file <code>cutoff_inputs.sh</code> shown below:
</p>


<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>

<span style="color: #268bd2;">cutoffs</span>=<span style="color: #2aa198;">"50 100 150 200 250 300 350 400 450 500"</span>

<span style="color: #268bd2;">basis_file</span>=BASIS_SET
<span style="color: #268bd2;">potential_file</span>=GTH_POTENTIALS
<span style="color: #268bd2;">template_file</span>=template.inp
<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp

<span style="color: #268bd2;">rel_cutoff</span>=60

<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #859900; font-weight: bold;">if</span> [ <span style="color: #839496;">!</span> -d $<span style="color: #268bd2;">work_dir</span> ] ; <span style="color: #859900; font-weight: bold;">then</span>
        mkdir $<span style="color: #268bd2;">work_dir</span>
    <span style="color: #859900; font-weight: bold;">else</span>
        rm -r $<span style="color: #268bd2;">work_dir</span>/*
    <span style="color: #859900; font-weight: bold;">fi</span>
    sed -e <span style="color: #2aa198;">"s/LT_rel_cutoff/${rel_cutoff}/g"</span> <span style="color: #b58900; font-weight: bold;">\</span>
        -e <span style="color: #2aa198;">"s/LT_cutoff/${ii}/g"</span> <span style="color: #b58900; font-weight: bold;">\</span>
        $<span style="color: #268bd2;">template_file</span> &gt; $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">input_file</span>
    cp $<span style="color: #268bd2;">basis_file</span> $<span style="color: #268bd2;">work_dir</span>
    cp $<span style="color: #268bd2;">potential_file</span> $<span style="color: #268bd2;">work_dir</span>
<span style="color: #859900; font-weight: bold;">done</span>
</pre>


<p>    
    The user should remember to set the permission of the new script
    file to be executable:
</p>


<pre class="example">chmod u+x ./cutoff_inputs.sh
</pre>


<p>    
    Entering the command line
</p>


<pre class="example">./cutoff_inputs.sh
</pre>

<p>
    generates directories <code>cutoff_50Ry</code>, <code>cutoff_100Ry</code>, &hellip;,
    each containing <code>BASIS_SET</code>, <code>GTH_POTENTIALS</code> and an input file
    <code>Si_bulk8.inp</code>, which is exactly the same as <code>template.inp</code>, except
    that <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> is set to 60, and <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> is set to the respective
    values in the range between 50 Ry and 500 Ry.
</p>
</div>

</div>

<div id="outline-container-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> Running Calculations</h4>
<div class="outline-text-4" id="text-2-2-2">


<p>    
    With the input files generated and checked, the next step is to
    run them. A bash script such as <code>cutoff_run.sh</code> shown below does
    the job:
</p>



<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>

<span style="color: #268bd2;">cutoffs</span>=<span style="color: #2aa198;">"50 100 150 200 250 300 350 400 450 500"</span>

<span style="color: #268bd2;">cp2k_bin</span>=cp2k.popt
<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp
<span style="color: #268bd2;">output_file</span>=Si_bulk8.out
<span style="color: #268bd2;">no_proc_per_calc</span>=2
<span style="color: #268bd2;">no_proc_to_use</span>=16

<span style="color: #268bd2;">counter</span>=1
<span style="color: #268bd2;">max_parallel_calcs</span>=$(<span style="color: #6c71c4; font-weight: bold;">expr</span> $<span style="color: #268bd2;">no_proc_to_use</span> / $<span style="color: #268bd2;">no_proc_per_calc</span>)
<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #268bd2; font-style: italic;">cd</span> $<span style="color: #268bd2;">work_dir</span>
    <span style="color: #859900; font-weight: bold;">if</span> [ -f $<span style="color: #268bd2;">output_file</span> ] ; <span style="color: #859900; font-weight: bold;">then</span>
        rm $<span style="color: #268bd2;">output_file</span>
    <span style="color: #859900; font-weight: bold;">fi</span>
    mpirun -np $<span style="color: #268bd2;">no_proc_per_calc</span> $<span style="color: #268bd2;">cp2k_bin</span> -o $<span style="color: #268bd2;">output_file</span> $<span style="color: #268bd2;">input_file</span> &amp;
    <span style="color: #268bd2; font-style: italic;">cd</span> ..
    <span style="color: #268bd2;">mod_test</span>=$(<span style="color: #6c71c4; font-weight: bold;">echo</span> <span style="color: #2aa198;">"$counter % $max_parallel_calcs"</span> | bc)
    <span style="color: #859900; font-weight: bold;">if</span> [ $<span style="color: #268bd2;">mod_test</span> -eq 0 ] ; <span style="color: #859900; font-weight: bold;">then</span>
        <span style="color: #268bd2; font-style: italic;">wait</span>
    <span style="color: #859900; font-weight: bold;">fi</span>
    <span style="color: #268bd2;">counter</span>=$(<span style="color: #6c71c4; font-weight: bold;">expr</span> $<span style="color: #268bd2;">counter</span> + 1)
<span style="color: #859900; font-weight: bold;">done</span>
<span style="color: #268bd2; font-style: italic;">wait</span>
</pre>


<p>    
    The above script is slightly complex, because it allows several
    jobs to run in parallel. Setting the variable <code>cp2k_bin</code> defines
    the path to the <code>CP2K</code> binary. In this case, the parallel version
    <code>cp2k.popt</code> is found in the system <code>PATH</code>. <code>no_proc_per_calc</code> sets
    the number of MPI processes to be used in parallel for each
    job. <code>no_proc_to_use</code> sets the total number of processors to be
    used for running all of the jobs. In the above example, the jobs
    are run on a 24 core local workstation, a total of 16 cores are
    used for performing the <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> convergence test calculations,
    and 2 cores are used for each calculation. This means up to 8 jobs
    will run in parallel, until the jobs are exhausted from the list
    given in <code>cutoffs</code>.
</p>
<p>
    The reader can write their own script where they see fit, and if
    he/she just want the jobs to run in serial, then there is no need
    for this complexity.
</p>
<p>
    Again
</p>


<pre class="example">chmod u+x ./cutoff_run.sh
</pre>

<p>
    followed by
</p>


<pre class="example">./cutoff_run.sh &amp;
</pre>

<p>
    runs the calculations in the background. This calculation only
    took a couple of minutes to complete on our local workstation.
</p>
</div>

</div>

<div id="outline-container-2-2-3" class="outline-4">
<h4 id="sec-2-2-3"><span class="section-number-4">2.2.3</span> Analysing Results</h4>
<div class="outline-text-4" id="text-2-2-3">


<p>
    After all of the calculations have finished, all the information
    about total energies and distribution of Gaussians on the
    multi-grid are written in the <code>Si_bulk8.out</code> files in each job
    directories.
</p>
<p>
    The total energy can be found in the section of the output shown
    below (in this example from <code>cutoff_100Ry/Si_bulk8.out</code>):
</p>



<pre class="example">SCF WAVEFUNCTION OPTIMIZATION
      
 Step     Update method      Time    Convergence         Total energy    Change
 ------------------------------------------------------------------------------
      
 Trace(PS):                                   32.0000000000
 Electronic density on regular grids:        -31.9999999980        0.0000000020
 Core density on regular grids:               31.9999999944       -0.0000000056
 Total charge density on r-space grids:       -0.0000000036
 Total charge density g-space grids:          -0.0000000036
      
    1 NoMix/Diag. 0.40E+00    0.4     1.10090760       -32.3804557631 -3.24E+01
    1 NoMix/Diag. 0.40E+00    0.4     1.10090760       -32.3804557631 -3.24E+01
      
 *** SCF run NOT converged ***
      
      
 Electronic density on regular grids:        -31.9999999980        0.0000000020
 Core density on regular grids:               31.9999999944       -0.0000000056
 Total charge density on r-space grids:       -0.0000000036
 Total charge density g-space grids:          -0.0000000036
      
 Overlap energy of the core charge distribution:               0.00000000005320
 Self energy of the core charge distribution:                -82.06393942512820
 Core Hamiltonian energy:                                     16.92855916540793
 Hartree energy:                                              42.17635056223367
 Exchange-correlation energy:                                 -9.42142606564066
 Electronic entropic energy:                                   0.00000000000000
 Fermi energy:                                                 0.00000000000000
      
 Total energy:                                               -32.38045576307407
</pre>


<p>
    Regexp search
</p>


<pre class="example">"^[ \t]*Total energy:" 
</pre>

<p>
    will find the relevant line.
</p>
<p>
    Similarly, information on distribution of Gaussians on the
    multi-grid can be found in the section:
</p>


<pre class="example">-------------------------------------------------------------------------------
----                             MULTIGRID INFO                            ----
-------------------------------------------------------------------------------
count for grid        1:           2720          cutoff [a.u.]           50.00
count for grid        2:           5000          cutoff [a.u.]           16.67
count for grid        3:           2760          cutoff [a.u.]            5.56
count for grid        4:             16          cutoff [a.u.]            1.85
total gridlevel count  :          10496
</pre>

<p>
    which tells us that for <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> of 100 Ry and <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> of 60
    Ry, 2720 product Gaussians has been distributed to grid level 1,
    the finest level, 5000 for level 2, 2760 for level 3 and 16 for
    level 4, the coarsest. The planewave cutoff for each multi-grid
    level can be read from the right-hand-side columns. Here <code>[a.u.]</code>
    means the Hartree energy unit, 1 Ha = 2 Ry.
</p>
<p>    
    It is much easier if we can gather all the information together
    into one file, which allows us to plot the results.  This can be
    done, again, by using a simple script. <code>cutoff_analyse.sh</code> shown
    below is such an example:
</p>



<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>

<span style="color: #268bd2;">cutoffs</span>=<span style="color: #2aa198;">"50 100 150 200 250 300 350 400 450 500"</span>

<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp
<span style="color: #268bd2;">output_file</span>=Si_bulk8.out
<span style="color: #268bd2;">plot_file</span>=cutoff_data.ssv

<span style="color: #268bd2;">rel_cutoff</span>=60

<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# Grid cutoff vs total energy"</span> &gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# Date: $(</span><span style="color: #6c71c4; font-weight: bold;">date</span><span style="color: #2aa198;">)"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# PWD: $PWD"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# REL_CUTOFF = $rel_cutoff"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> -n <span style="color: #2aa198;">"# Cutoff (Ry) | Total Energy (Ha)"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2;">grid_header</span>=true
<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #268bd2;">total_energy</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*Total energy'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | awk <span style="color: #2aa198;">'{print $3}'</span>)
    <span style="color: #268bd2;">ngrids</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*QS| Number of grid levels:'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | <span style="color: #b58900; font-weight: bold;">\</span>
             awk <span style="color: #2aa198;">'{print $6}'</span>)
    <span style="color: #859900; font-weight: bold;">if</span> $<span style="color: #268bd2;">grid_header</span> ; <span style="color: #859900; font-weight: bold;">then</span>
        <span style="color: #859900; font-weight: bold;">for</span> ((<span style="color: #268bd2;">igrid</span>=1; igrid &lt;= $<span style="color: #268bd2;">ngrids</span>; igrid++)) ; <span style="color: #859900; font-weight: bold;">do</span>
            <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">" | NG on grid %d"</span> $<span style="color: #268bd2;">igrid</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
        <span style="color: #859900; font-weight: bold;">done</span>
        <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"\n"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
        <span style="color: #268bd2;">grid_header</span>=false
    <span style="color: #859900; font-weight: bold;">fi</span>
    <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"%10.2f  %15.10f"</span> $<span style="color: #268bd2;">ii</span> $<span style="color: #268bd2;">total_energy</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
    <span style="color: #859900; font-weight: bold;">for</span> ((<span style="color: #268bd2;">igrid</span>=1; igrid &lt;= $<span style="color: #268bd2;">ngrids</span>; igrid++)) ; <span style="color: #859900; font-weight: bold;">do</span>
        <span style="color: #268bd2;">grid</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*count for grid'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | <span style="color: #b58900; font-weight: bold;">\</span>
               awk -v <span style="color: #268bd2;">igrid</span>=$<span style="color: #268bd2;">igrid</span> <span style="color: #2aa198;">'(NR == igrid){print $5}'</span>)
        <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"  %6d"</span> $<span style="color: #268bd2;">grid</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
    <span style="color: #859900; font-weight: bold;">done</span>
    <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"\n"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #859900; font-weight: bold;">done</span>
</pre>


<p>
    Type
</p>


<pre class="example">chmod u+x ./cutoff_analyse.sh
</pre>

<p>
    and then run it using
</p>


<pre class="example">./cutoff_analyse.sh
</pre>

<p>
    will produce a file named <code>cutoff_data.ssv</code>, which looks like:
</p>


<pre class="example"># Grid cutoff vs total energy
# Date: Mon Jan 20 21:20:34 GMT 2014
# PWD: /home/tong/tutorials/converging_grid/sample_output
# REL_CUTOFF = 60
# Cutoff (Ry) | Total Energy (Ha) | NG on grid 1 | NG on grid 2 | NG on grid 3 | NG on grid 4
     50.00   -32.3795329864    5048    5432      16       0
    100.00   -32.3804557631    2720    5000    2760      16
    150.00   -32.3804554850    2032    3016    5432      16
    200.00   -32.3804554982    1880    2472    3384    2760
    250.00   -32.3804554859     264    4088    3384    2760
    300.00   -32.3804554843     264    2456    5000    2776
    350.00   -32.3804554846      56    1976    5688    2776
    400.00   -32.3804554851      56    1976    3016    5448
    450.00   -32.3804554851       0    2032    3016    5448
    500.00   -32.3804554850       0    2032    3016    5448
</pre>


<p>    
    The data shows that given the <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> value of 60 Ry, setting
    <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> to 250 Ry and above would give an error in total energy
    less than \(10^-8\) Ha. The reader may also notice that as <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>
    increases, the number of Gaussians being assigned to the finest
    grids decreases. Therefore, simply increasing <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> without
    increasing <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> may eventually lead to a slow convergence
    in energy, as more and more Gaussians get pushed to coarser grid
    levels, negating the increase in <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>.
</p>
<p>
    In this example, the test results point to 250 Ry as a good choice
    for <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>, as the total energy is converged, and the
    distribution of Gaussian functions on the grids are reasonable: it
    is the lowest cutoff energy where the finest grid level is used,
    but at the same time with the majority of the Gaussians on the
    coarser grids.
</p>
</div>
</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Converging <code>REL_CUTOFF</code></h3>
<div class="outline-text-3" id="text-2-3">


<p>
   In the next step, we vary the value of <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> while keeping
   <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> fixed at 250 Ry.
</p>

</div>

<div id="outline-container-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> Generating Inputs</h4>
<div class="outline-text-4" id="text-2-3-1">


<p>
    For the energy convergence test with varying <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a>, we
    follow a similar procedure as that for <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a>. Using the same
    template input file <code>template.inp</code>, we can write a script called
    <code>rel_cutoff_inputs.sh</code>:
</p>



<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>

<span style="color: #268bd2;">rel_cutoffs</span>=<span style="color: #2aa198;">"10 20 30 40 50 60 70 80 90 100"</span>

<span style="color: #268bd2;">basis_file</span>=BASIS_SET
<span style="color: #268bd2;">potential_file</span>=GTH_POTENTIALS
<span style="color: #268bd2;">template_file</span>=template.inp
<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp

<span style="color: #268bd2;">cutoff</span>=250

<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">rel_cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=rel_cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #859900; font-weight: bold;">if</span> [ <span style="color: #839496;">!</span> -d $<span style="color: #268bd2;">work_dir</span> ] ; <span style="color: #859900; font-weight: bold;">then</span>
        mkdir $<span style="color: #268bd2;">work_dir</span>
    <span style="color: #859900; font-weight: bold;">else</span>
        rm -r $<span style="color: #268bd2;">work_dir</span>/*
    <span style="color: #859900; font-weight: bold;">fi</span>
    sed -e <span style="color: #2aa198;">"s/LT_cutoff/${cutoff}/g"</span> <span style="color: #b58900; font-weight: bold;">\</span>
        -e <span style="color: #2aa198;">"s/LT_rel_cutoff/${ii}/g"</span> <span style="color: #b58900; font-weight: bold;">\</span>
        $<span style="color: #268bd2;">template_file</span> &gt; $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">input_file</span>
    cp $<span style="color: #268bd2;">basis_file</span> $<span style="color: #268bd2;">work_dir</span>
    cp $<span style="color: #268bd2;">potential_file</span> $<span style="color: #268bd2;">work_dir</span>
<span style="color: #859900; font-weight: bold;">done</span>
</pre>


<p>    
    Setting the permission for the script to "executable", and running
    it produces directories <code>rel_cutoff_10Ry</code>, <code>rel_cutoff_20Ry</code>, &hellip;,
    each containing files <code>BASIS_SET</code>, <code>GTH_POTENTIALS</code> and an input
    <code>Si_bulk8.inp</code>, which is identical to <code>template.inp</code>, except that
    <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> is set to 250, and <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> is set to 10, 20, &hellip;,
    100 respectively.
</p>
</div>

</div>

<div id="outline-container-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> Running Calculations</h4>
<div class="outline-text-4" id="text-2-3-2">


<p>
    Again to run the calculations, we can use the script
    <code>rel_cutoff_run.sh</code>, as shown below:
</p>



<pre class="src src-sh"><span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/</span><span style="color: #859900; font-weight: bold;">bash</span>

<span style="color: #268bd2;">rel_cutoffs</span>=<span style="color: #2aa198;">"10 20 30 40 50 60 70 80 90 100"</span>

<span style="color: #268bd2;">cp2k_bin</span>=cp2k.popt
<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp
<span style="color: #268bd2;">output_file</span>=Si_bulk8.out
<span style="color: #268bd2;">no_proc_per_calc</span>=2
<span style="color: #268bd2;">no_proc_to_use</span>=16

<span style="color: #268bd2;">counter</span>=1
<span style="color: #268bd2;">max_parallel_calcs</span>=$(<span style="color: #6c71c4; font-weight: bold;">expr</span> $<span style="color: #268bd2;">no_proc_to_use</span> / $<span style="color: #268bd2;">no_proc_per_calc</span>)
<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">rel_cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=rel_cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #268bd2; font-style: italic;">cd</span> $<span style="color: #268bd2;">work_dir</span>
    <span style="color: #859900; font-weight: bold;">if</span> [ -f $<span style="color: #268bd2;">output_file</span> ] ; <span style="color: #859900; font-weight: bold;">then</span>
        rm $<span style="color: #268bd2;">output_file</span>
    <span style="color: #859900; font-weight: bold;">fi</span>
    mpirun -np $<span style="color: #268bd2;">no_proc_per_calc</span> $<span style="color: #268bd2;">cp2k_bin</span> -o $<span style="color: #268bd2;">output_file</span> $<span style="color: #268bd2;">input_file</span> &amp;
    <span style="color: #268bd2; font-style: italic;">cd</span> ..
    <span style="color: #268bd2;">mod_test</span>=$(<span style="color: #6c71c4; font-weight: bold;">echo</span> <span style="color: #2aa198;">"$counter % $max_parallel_calcs"</span> | bc)
    <span style="color: #859900; font-weight: bold;">if</span> [ $<span style="color: #268bd2;">mod_test</span> -eq 0 ] ; <span style="color: #859900; font-weight: bold;">then</span>
        <span style="color: #268bd2; font-style: italic;">wait</span>
    <span style="color: #859900; font-weight: bold;">fi</span>
    <span style="color: #268bd2;">counter</span>=$(<span style="color: #6c71c4; font-weight: bold;">expr</span> $<span style="color: #268bd2;">counter</span> + 1)
<span style="color: #859900; font-weight: bold;">done</span>
<span style="color: #268bd2; font-style: italic;">wait</span>
</pre>


<p>    
    In the above example, again, we have used 16 cores in total, and
    with each job using 2 MPI processes. To run the jobs, use:
</p>


<pre class="example">./rel_cutoff_run.sh &amp;
</pre>


</div>

</div>

<div id="outline-container-2-3-3" class="outline-4">
<h4 id="sec-2-3-3"><span class="section-number-4">2.3.3</span> Analysing Results</h4>
<div class="outline-text-4" id="text-2-3-3">


<p>
    Total energies and distribution of Gaussian functions on the
    multi-grid are obtained the same way from the results as that for
    the <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_CUTOFF"><code>CUTOFF</code></a> calculations.
</p>
<p>    
    To put all of the results from the <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> calculations in
    one place, we can make some minor modifications to
    <code>cutoff_analyse.sh</code> and save it as <code>rel_cutoff_analyse.sh</code>:
</p>



<pre class="src src-sh"> <span style="color: #586e75;">#</span><span style="color: #586e75;">!/bin/bash</span>

<span style="color: #268bd2;">rel_cutoffs</span>=<span style="color: #2aa198;">"10 20 30 40 50 60 70 80 90 100"</span>

<span style="color: #268bd2;">input_file</span>=Si_bulk8.inp
<span style="color: #268bd2;">output_file</span>=Si_bulk8.out
<span style="color: #268bd2;">plot_file</span>=rel_cutoff_data.ssv

<span style="color: #268bd2;">cutoff</span>=250

<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# Rel Grid cutoff vs total energy"</span> &gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# Date: $(</span><span style="color: #6c71c4; font-weight: bold;">date</span><span style="color: #2aa198;">)"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# PWD: $PWD"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> <span style="color: #2aa198;">"# CUTOFF = ${cutoff}"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2; font-style: italic;">echo</span> -n <span style="color: #2aa198;">"# Rel Cutoff (Ry) | Total Energy (Ha)"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #268bd2;">grid_header</span>=true
<span style="color: #859900; font-weight: bold;">for</span> ii<span style="color: #859900; font-weight: bold;"> in</span> $<span style="color: #268bd2;">rel_cutoffs</span> ; <span style="color: #859900; font-weight: bold;">do</span>
    <span style="color: #268bd2;">work_dir</span>=rel_cutoff_${<span style="color: #268bd2;">ii</span>}Ry
    <span style="color: #268bd2;">total_energy</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*Total energy'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | awk <span style="color: #2aa198;">'{print $3}'</span>)
    <span style="color: #268bd2;">ngrids</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*QS| Number of grid levels:'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | <span style="color: #b58900; font-weight: bold;">\</span>
             awk <span style="color: #2aa198;">'{print $6}'</span>)
    <span style="color: #859900; font-weight: bold;">if</span> $<span style="color: #268bd2;">grid_header</span> ; <span style="color: #859900; font-weight: bold;">then</span>
        <span style="color: #859900; font-weight: bold;">for</span> ((<span style="color: #268bd2;">igrid</span>=1; igrid &lt;= $<span style="color: #268bd2;">ngrids</span>; igrid++)) ; <span style="color: #859900; font-weight: bold;">do</span>
            <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">" | NG on grid %d"</span> $<span style="color: #268bd2;">igrid</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
        <span style="color: #859900; font-weight: bold;">done</span>
        <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"\n"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
        <span style="color: #268bd2;">grid_header</span>=false
    <span style="color: #859900; font-weight: bold;">fi</span>
    <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"%10.2f  %15.10f"</span> $<span style="color: #268bd2;">ii</span> $<span style="color: #268bd2;">total_energy</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
    <span style="color: #859900; font-weight: bold;">for</span> ((<span style="color: #268bd2;">igrid</span>=1; igrid &lt;= $<span style="color: #268bd2;">ngrids</span>; igrid++)) ; <span style="color: #859900; font-weight: bold;">do</span>
        <span style="color: #268bd2;">grid</span>=$(<span style="color: #6c71c4; font-weight: bold;">grep</span> -e <span style="color: #2aa198;">'^[ \t]*count for grid'</span> $<span style="color: #268bd2;">work_dir</span>/$<span style="color: #268bd2;">output_file</span> | <span style="color: #b58900; font-weight: bold;">\</span>
               awk -v <span style="color: #268bd2;">igrid</span>=$<span style="color: #268bd2;">igrid</span> <span style="color: #2aa198;">'(NR == igrid){print $5}'</span>)
        <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"  %6d"</span> $<span style="color: #268bd2;">grid</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
    <span style="color: #859900; font-weight: bold;">done</span>
    <span style="color: #268bd2; font-style: italic;">printf</span> <span style="color: #2aa198;">"\n"</span> &gt;&gt; $<span style="color: #268bd2;">plot_file</span>
<span style="color: #859900; font-weight: bold;">done</span>
</pre>


<p>    
    Making the script executable, and running the script using
</p>


<pre class="example">./rel_cutoff_analyse.sh
</pre>

<p>
    produces the following results written in file
    <code>rel_cutoff_data.ssv</code>:
</p>



<pre class="example"># Rel Grid cutoff vs total energy
# Date: Mon Jan 20 00:45:14 GMT 2014
# PWD: /home/tong/tutorials/converging_grid/sample_output
# CUTOFF = 250
# Rel Cutoff (Ry) | Total Energy (Ha) | NG on grid 1 | NG on grid 2 | NG on grid 3 | NG on grid 4
     10.00   -32.3902980020       0       0    2032    8464
     20.00   -32.3816384686       0     264    4088    6144
     30.00   -32.3805115576       0    2032    3016    5448
     40.00   -32.3805116025      56    1976    3016    5448
     50.00   -32.3804555002     264    2456    5000    2776
     60.00   -32.3804554859     264    4088    3384    2760
     70.00   -32.3804554859    1880    2472    3384    2760
     80.00   -32.3804554859    1880    2472    3384    2760
     90.00   -32.3804554848    2032    3016    5432      16
    100.00   -32.3804554848    2032    3016    5432      16
</pre>


<p>
    The results show that as one increases the value of <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a>,
    more Gaussians get mapped onto the finer grids. The error in total
    energy reduces to less than \(10^-8\) Ha when <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a> is
    greater or equal to 60 Ry. The results thus indicate that 60 Ry is
    indeed a suitable choice for the value of <a href="http://manual.cp2k.org/trunk/CP2K_INPUT/FORCE_EVAL/DFT/MGRID.html#desc_REL_CUTOFF"><code>REL_CUTOFF</code></a>.
</p>
<p>
    So finally we conclude that the setting
</p>


<pre class="src src-cp2k"><span style="color: #268bd2;">&amp;MGRID</span>
  <span style="color: #859900; font-weight: bold;">CUTOFF</span> 250
  <span style="color: #859900; font-weight: bold;">REL_CUTOFF</span> 60 
<span style="color: #268bd2;">&amp;END MGRID</span>
</pre>

<p>
    is sufficient for a calculation with the required accuracy.
</p></div>
</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: Wednesday, 2014/01/22</p>
<p class="author">Author: Lianheng Tong</p>
<p class="creator">Org version 7.8.03 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
