@SET PROJECT Ru_C_repeat
@SET XYZ rucc_4l23_a2.718_d3_opt.xyz 
@SET RUN  ENERGY
@SET GUESS ATOMIC

&GLOBAL
  PROJECT ${PROJECT}
  PRINT_LEVEL MEDIUM
  RUN_TYPE ${RUN}
  FLUSH_SHOULD_FLUSH T
&END GLOBAL

&FORCE_EVAL
  METHOD QS
  &DFT
    BASIS_SET_FILE_NAME  BASIS_MOLOPT_marci
    POTENTIAL_FILE_NAME  GTH_POTENTIALS
    &MGRID
      NGRIDS 5
      CUTOFF 500
    &END MGRID
    &QS
      METHOD GPW
      EXTRAPOLATION  PS
      EXTRAPOLATION_ORDER  4
      MAP_CONSISTENT
    &END QS
    &SCF
      SCF_GUESS  ${GUESS}
      EPS_SCF 1.0E-6
      MAX_SCF 500
      ADDED_MOS  2500
      CHOLESKY INVERSE
      &SMEAR  ON
        METHOD FERMI_DIRAC
        ELECTRONIC_TEMPERATURE [K] 500
      &END SMEAR
      &DIAGONALIZATION
         ALGORITHM STANDARD
         EPS_ADAPT 0.01
      &END DIAGONALIZATION
      &MIXING
          METHOD BROYDEN_MIXING
          ALPHA   0.1
          BETA    1.5
          NBROYDEN  8
      &END
      &PRINT
        &RESTART
          &EACH
              QS_SCF 10
          &END
          ADD_LAST NUMERIC
        &END
      &END
    &END SCF
    &XC
      &XC_FUNCTIONAL
        &PBE
           PARAMETRIZATION revPBE
        &END
      &END XC_FUNCTIONAL
      &XC_GRID
        XC_SMOOTH_RHO NN50
        XC_DERIV NN50_SMOOTH
      &END
      &VDW_POTENTIAL
       POTENTIAL_TYPE PAIR_POTENTIAL
       &PAIR_POTENTIAL
          TYPE DFTD3
          CALCULATE_C9_TERM .TRUE.
          REFERENCE_C9_TERM .TRUE.
          LONG_RANGE_CORRECTION  .FALSE.
          PARAMETER_FILE_NAME dftd3.dat
          VERBOSE_OUTPUT .TRUE.
          REFERENCE_FUNCTIONAL revPBE
          R_CUTOFF [angstrom] 16.
          EPS_CN 1.0E-6
          KIND_COORDINATION_NUMBERS  10  1
          KIND_COORDINATION_NUMBERS  4   2
       &END
      &END
    &END XC
    &PRINT
      &V_HARTREE_CUBE
      &END
    &END PRINT
  &END DFT
  &SUBSYS
    &CELL
   A      62.51400000       0.00000000       0.00000000
   B      31.25700000      54.13804672       0.00000000
   C     0.00000      0.00000      25.0
    &END CELL

    &TOPOLOGY
      COORD_FILE_NAME ${XYZ}
      COORDINATE XYZ
      CONNECTIVITY OFF
    &END TOPOLOGY
    &KIND Ru
      BASIS_SET  SZVP-RESPONSE-GTH-q8b
      POTENTIAL GTH-PBE-q8
    &END KIND

    &KIND C
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q4
    &END
  &END SUBSYS
  &PROPERTIES
    &RESP
      #for this particular surface system, fitting the
      #variance of the potential gives some improvement
      USE_REPEAT_METHOD
      &SLAB_SAMPLING
        RANGE 2.0 4.0
        LENGTH 2.0
        ATOM_LIST 1..1250 
        SURF_DIRECTION -Z 
      &END
      ##  CONSTRAINTS ## 
      # C1
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 1..751 
      &END
      # C2
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 752..892
      &END
      # C3
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 893..988
      &END
      # C4
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 989..1082
      &END
      #C5
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 1083..1211
      &END
      # C6
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 1212..1250
      &END
      # Ru1
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 1251..1779
      &END
      # Ru2
      &CONSTRAINT
       EQUAL_CHARGES
       ATOM_LIST 1780..3366
      &END
      &PRINT
       &COORD_FIT_POINTS
       &END
       &RESP_CHARGES_TO_FILE
       &END
       &V_RESP_CUBE
       &END
      &END
      STRIDE 3
    &END RESP
  &END
&END FORCE_EVAL

